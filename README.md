# UuRingLane ğŸ“š

UuRingLane ã¯ã€SNSã®æœ€æ–°ãƒã‚¹ãƒˆã‚„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿æŒã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«è¨­è¨ˆã•ã‚ŒãŸã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

## ğŸš€ ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç‰¹å¾´

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¦ãƒ‹ãƒ¼ã‚¯ãªè¨­è¨ˆæ€æƒ³ã‚’æŒã£ã¦ã„ã¾ã™ï¼š

- **UUIDé…åˆ—ã«ç‰¹åŒ–**: æ ¼ç´ãƒ‡ãƒ¼ã‚¿ã‚’ [Uuid] ã®å›ºå®šé•·é…åˆ—ã«é™å®šã€‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ¥µé™ã¾ã§æ’é™¤ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ¢ãƒªåŠ¹ç‡ã¨ãƒªãƒ‹ã‚¢ãªèµ°æŸ»é€Ÿåº¦ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚
- **å¯å¤‰æ¬¡å…ƒï¼ˆDimensionï¼‰æ§‹é€ **: 1ã¤ã®è¡Œï¼ˆ`UuRingLaneRow`ï¼‰ã«å«ã‚ã‚‹UUIDã®å€‹æ•°ã¯åˆæœŸåŒ–æ™‚ã«è‡ªç”±ã«å¤‰æ›´å¯èƒ½ã€‚[PostID, AuthorID] ã ã‘ã§ãªãã€[PostID, AuthorID, CategoryID, TagID] ã¨ã„ã£ãŸå¤šè§’çš„ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ§‹æˆã§ãã¾ã™ã€‚
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŒ‡å®šæ¤œç´¢**: æ¤œç´¢æ™‚ã«ã€Œé…åˆ—ã®ä½•ç•ªç›®ã®è¦ç´ ã‚’å¯¾è±¡ã«ã™ã‚‹ã‹ã€ã‚’å‹•çš„ã«æŒ‡å®šå¯èƒ½ã€‚ä¸€ã¤ã®ãƒ—ãƒ¼ãƒ«ã§ã€æŠ•ç¨¿è€…åˆ¥æ¤œç´¢ã€ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¤œç´¢ãªã©å¤šç›®çš„ãªæŠ½å‡ºãŒå¯èƒ½ã§ã™ã€‚
- **OOMã‚¬ãƒ¼ãƒ‰ (Safety Limit)**: åˆæœŸåŒ–æ™‚ã«ã‚·ã‚¹ãƒ†ãƒ ã®ç©ºããƒ¡ãƒ¢ãƒªã‚’ãƒã‚§ãƒƒã‚¯ã€‚è¦æ±‚é‡ãŒç©ºããƒ¡ãƒ¢ãƒªã®80%ã‚’è¶…ãˆã‚‹å ´åˆã€OOMã«ã‚ˆã‚‹ã‚·ã‚¹ãƒ†ãƒ åœæ­¢ã‚’é˜²ããŸã‚åˆæœŸåŒ–ã‚’å®‰å…¨ã«ä¸­æ–­ã—ã¾ã™ã€‚
- **ãƒãƒ«ãƒãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¼ãƒ«ç®¡ç†**: ãƒ©ãƒ™ãƒ«ï¼ˆåå‰ï¼‰ã‚’ä»˜ã‘ã¦è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸãƒ—ãƒ¼ãƒ«ã‚’ç®¡ç†ã€‚ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ã€ãƒˆãƒ¬ãƒ³ãƒ‰ç”¨ãªã©ã€ç”¨é€”åˆ¥ã«å¸æ›¸ã‚’é…ç½®ã§ãã¾ã™ã€‚
- **ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ»ã‚¢ã‚¯ã‚»ã‚¹**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ¬ã‚¸ã‚¹ãƒˆãƒªæ©Ÿèƒ½ã‚’å†…è”µã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ã‚‰ã‚†ã‚‹å ´æ‰€ã‹ã‚‰åå‰ã‚’æŒ‡å®šã—ã¦ã€å³åº§ã«ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¼ãƒ«ã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

## ğŸ› ï¸ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Installation)

`Cargo.toml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆGitHubã‹ã‚‰ç›´æ¥å‚ç…§ã™ã‚‹å ´åˆï¼‰ï¼š

```toml
[dependencies]
uuringlane = { git = "https://github.com/ha-desu/uuringlane_rs.git" }
uuid = { version = "1.0", features = ["v7", "serde"] }
```

## ğŸ“– ä½¿ã„æ–¹ (Usage)

ä»¥ä¸‹ã¯ã€SNSã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç®¡ç†ã‚’æƒ³å®šã—ãŸåŸºæœ¬çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚

```rust
use uuringlane::{UuRingLane, UuRingLaneRow};
use std::collections::HashSet;
use uuid::Uuid;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 1. å¸æ›¸ã®åˆæœŸåŒ–ï¼ˆinitï¼‰
    // ãƒ©ãƒ™ãƒ« "main_timeline"ã€æœ€å¤§100ä¸‡ä»¶ã€2æ¬¡å…ƒ [PostID, AuthorID] ã§ä½œæˆ
    // â€» ã“ã“ã§ãƒ¡ãƒ¢ãƒªå®¹é‡ãƒã‚§ãƒƒã‚¯ãŒèµ°ã‚Šã¾ã™
    let timeline = UuRingLane::init("main_timeline", 1_000_000, 2)?;

    // 2. ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã¨ä¸€æ‹¬æŒ¿å…¥ï¼ˆinsert_batchï¼‰
    // ã‚µãƒ³ãƒ—ãƒ«ç”¨ã« UUID v7 (æ™‚ç³»åˆ—é †) ã‚’ä½¿ç”¨
    let user_a = Uuid::now_v7();
    let post_id_1 = Uuid::now_v7();
    let post_id_2 = Uuid::now_v7();

    let rows = vec![
        UuRingLaneRow { values: Box::new([post_id_1, user_a]) },
        UuRingLaneRow { values: Box::new([post_id_2, user_a]) },
    ];
    
    // æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ãŒå¸¸ã«å…ˆé ­ã«æ¥ã‚‹ã‚ˆã†ã«ç®¡ç†ã•ã‚Œã¾ã™
    timeline.insert_batch(rows)?;

    // 3. ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„ãƒãƒ³ãƒ‰ãƒ©ã‹ã‚‰åå‰ã§å‘¼ã³å‡ºã—ï¼ˆfindï¼‰
    if let Some(pool) = UuRingLane::find("main_timeline") {
        let mut following = HashSet::new();
        following.insert(user_a);

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ 1 (AuthorID) ãŒ user_a ã§ã‚ã‚‹ã‚‚ã®ã‚’æœ€å¤§20ä»¶æŠ½å‡º
        let results = pool.curate_by(1, &following, 20);

        // PostID (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0) ã‚’å–ã‚Šå‡ºã—ã¦è¡¨ç¤º
        let timeline_posts: Vec<Uuid> = results.iter().map(|r| r.values[0]).collect();
        println!("ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³: {:?}", timeline_posts);
    }

    // 4. ãƒ‡ãƒ¼ã‚¿å¾©å…ƒï¼ˆrestoreï¼‰
    // ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•æ™‚ãªã©ã«ã€DBã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å±•é–‹ã™ã‚‹å ´åˆ
    // timeline.restore(saved_rows)?;

    // 5. ä¸è¦ã«ãªã£ãŸã‚‰ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾ï¼ˆvacateï¼‰
    timeline.vacate();

    Ok(())
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
cargo test
```

## âš–ï¸ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ (License)

MIT License
Created by ha-desu (and the "Just Idea")